var he=Object.defineProperty;var fe=(o,t,a)=>t in o?he(o,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):o[t]=a;var L=(o,t,a)=>(fe(o,typeof t!="symbol"?t+"":t,a),a);import{w as e,P as v,e as H,a as f,p as T,I as ge,D as be,h as we,O as Te,d as F,b as q,L as ae,V as x,i as N,j as V,T as se,k as _e,R as X,F as ne,l as re,m as Me,n as ie,o as ve,q as Q,C as ce,r as le}from"./game.e9cd2ea9.js";import{G as W}from"./script.be6caa28.js";import S,{Death as $}from"./health.78fa8c8a.js";import{KeyboardControls as Z}from"./keyboardControls.8ffada6f.js";import{Movement as K}from"./movement.3ad58240.js";import{Score as C}from"./score.6776b201.js";import{shoot as Se}from"./shooting.6597186d.js";import{UserInterface as U}from"./userInterface.c18717de.js";import{dealDamage as Y}from"./damage.system.3c88af9b.js";import{getEquippedItem as Ae}from"./inventory.24d76a8d.js";import{d as J,s as ee,m as te,A as oe}from"./attack.ec1f7c90.js";const[Ie]=ae("slime");class P{constructor(){L(this,"speed",.75);L(this,"lastHop",performance.now())}}class Pe extends W{initialize(){window.webApi&&window.webApi.onmessage("slime",()=>{Ie("spawn enemy");for(let t=0;t<20;t++)this.createSlime()}),setInterval(this.createSlime,5e3)}every_frame(){const t=e.getTag(B),[a]=e.get(t,[v]);e.do_with([H,P,$],([c],i)=>{e.events.emit("enemyDied",i),f.removeObjectFromScene(c),e.deleteEntity(i)});const d=e.submitQuery([v,H,P]);for(const[[c,i,r],m]of d){const p=T.getBodyPosition(a),s=T.getBodyPosition(c),l=J(p,s),g=ee(p,s),{speed:u,lastHop:_}=r;let b=0,y=0;const n=new x(0,0,0);if(l<20){const h=te(g,u);n.x+=h[0]*20,n.z+=h[2]*20,b+=20}if(Math.random()<=.02)for(const[h,w]of d){if(w===m)return;const[k]=e.get(w,[v]),I=T.getBodyPosition(k),R=J(I,s),ye=ee(I,s);if(R<20){y+=1,b+=1;const z=te(ye,u);n.x+=z[0],n.y+=z[1],n.z+=z[2]}}if(y>0){const h=Math.max(Math.min(y/12,1),.02738276869058609);i.children[0].material.color.b=h,f.updateMaterial(i)}b&&performance.now()-_>1125&&(r.lastHop=performance.now(),n.x/=b,n.z/=b,T.addForceConditionalRaycast({force:{object:c,vector:[n.x,3,n.z]},raycast:{id:0,from:s,to:[s[0]+(Math.random()*3-1.5),s[1]-1.5,s[2]+(Math.random()*3-1.5)]}}))}}createInstancedSlime({geometries:t,materials:a,meshes:d}){const i=new SharedArrayBuffer(Float32Array.BYTES_PER_ELEMENT*16*400),r=new Float32Array(i),m=new ge(r,Float32Array.BYTES_PER_ELEMENT);m.setUsage(be);const p=d.map(({geometry:s,material:l,materialCount:g})=>{const u=s-1,_=l-1,b=t[u],y=a.slice(_,_+g),n=new we(b,y[0],400);n.instanceMatrix=m;for(let h=0;h<400;h++){const w=new Te;w.position.set(Math.random()*60-30,h,Math.random()*60-30),w.updateMatrix(),n.setMatrixAt(h,w.matrix)}return n.instanceMatrix.needsUpdate=!0,n});return p.forEach(s=>{s.scale.set(.7,.7,.7),f.addObjectToScene(s)}),p}async createSlime(){const t={speed:.75,lastHop:performance.now()},a=new S(5,5),d={uri:"./models/slime/slime.glb"},c={radius:1.39/2},i={mass:1,isGhost:!1,shouldRotate:!0},r=await F.loadModel(d);await F.loadModelData(d),r.children[1].material=r.children[1].material.clone(),r.scale.set(.7,.7,.7),r.name="Slime",f.addObjectToScene(r);const m=()=>Math.random()*50-25,p=T.createSphere(i,{pos:[m(),60,m()],scale:[1,1,1],quat:[0,0,0,1]},c),s=e.spawn([q,v,P,S],[r,p,t,a]);r.traverse(l=>l.userData.entityId=s),T.registerCollisionCallback(p,Y(e)(3))}}var Ne=Object.freeze(Object.defineProperty({__proto__:null,Slime:P,default:Pe},Symbol.toStringTag,{value:"Module"}));const D=Symbol("Target");function de(){const o="img/fire.png",t=new N(new V({color:16711680,transparent:!0,opacity:.3,visible:!0,map:new se().load(o),depthTest:!1}));return t.position.set(0,30,0),t.scale.set(10,10,10),f.addObjectToScene(t),{sprite:t,abilities:0}}function j(o){o.abilities+=1;const t="img/icons.jpg",a=new se().load(t);a.offset=new _e(1/10,1-1/12),a.wrapS=X,a.wrapT=X;const d=new N(new V({color:16777215,transparent:!0,visible:!0,map:a,alphaMap:a,depthTest:!1})),c=.1,i=.3,r=Math.PI/2*o.abilities,m=i*Math.sin(r),p=i*Math.cos(r);d.position.set(p,m,0),d.scale.set(c,c,c),o.sprite.add(d)}function me(o,t){const[a]=e.get(o,[v]),[d,c,i]=T.getBodyPosition(a),r=new x(d,c,i);function m(){const l=new Set;return f.scene.traverseVisible(g=>{const u=g.userData.entityId;!u||!new ne().setFromProjectionMatrix(new re().multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse)).containsPoint(g.position)||(e.has(u,P)||e.has(u,G))&&l.add(u)}),l}const p=m();let s=999999999;for(const l of p){const[g]=e.get(l,[v]),[u,_,b]=T.getBodyPosition(g),y=new x(u,_,b),n=Math.abs(y.distanceTo(r));n<s&&(s=n,e.removeTag(D),e.addTag(l,D))}}function pe({sprite:o}){if(e.hasTag(D)){const t=e.getTag(D),[a]=e.get(t,[v]),[d,c,i]=T.getBodyPosition(a),r=new x(d,c,i);o.visible=!0,o.position.copy(r),o.rotateX(.0333),o.rotateY(-.0333),o.rotateZ(.0333)}else o.visible=!1}var Ve=Object.freeze(Object.defineProperty({__proto__:null,TARGET_TAG:D,makeTargetIndicator:de,addAbilityToTargetIndicator:j,updateTargetIndicator:me,syncTargetIndicator:pe},Symbol.toStringTag,{value:"Module"}));const[Ee]=ae("engine:todo"),B=Symbol("player"),xe=()=>{const[o]=e.get(e.getTag(ce),[le]);return new x(0,0,-1).applyQuaternion(o.quaternion)},A=e.createEntity();e.addTag(A,B);const E=new Me(30,1,.1,100).rotateY(Math.PI).translateY(3).rotateX(-Math.PI/9).translateZ(1);let ue=null;f.loadModel().then(o=>{ue=o;const t=o.mesh;console.log(o.animations),ie(o,"Idle"),t.add(E),f.addObjectToScene(t);const a=800,d=10,c=new Audio("audio/squelch.mp3");let i=0;document.addEventListener("mousedown",async y=>{if(y.button!==0||performance.now()-i<a)return;i=performance.now(),M("1H_Melee_Attack_Slice_Diagonal"),setTimeout(()=>M("Idle"),340);const n=new ne().setFromProjectionMatrix(new re().multiplyMatrices(E.projectionMatrix,E.matrixWorldInverse));let h=!1;f.scene.traverseVisible(w=>{h||w.isMesh&&(n.containsPoint(w.position)||n.intersectsObject(w))&&e.has(w.userData.entityId,S)&&(h=!0,setTimeout(()=>{var I,R;const k=(R=(I=Ae())==null?void 0:I.damage)!=null?R:d;Y(e)(k)(w.userData.entityId),c.currentTime=.5,c.play()},500))})});const r=new S(250,250),m={score:0},p=T.createSphere({mass:100,shouldRotate:!0,isGhost:!1},{pos:[0,20,0],scale:[1,1,1],quat:[0,0,0,1]},{radius:1}),s=new K;s.jumpVelocity=5,s.walkVelocity=14;const l=new Z({MoveForward:["w_down"],MoveBackward:["s_down"],MoveLeft:["a_down"],MoveRight:["d_down"],Idle:["w_up","a_up","s_up","d_up"]});l.addListener("Idle",()=>{M("Idle")}),l.addListener("MoveForward",()=>{M("Running_A")}),l.addListener("MoveBack",()=>{M("Running_A")}),l.addListener("MoveLeft",()=>{M("Running_A")}),l.addListener("MoveRight",()=>{M("Running_A")});const g=new U("50%","80%","52px Arial","red","[health goes here]");e.put(A,[q,v,S,C,K,Z,U],[t,p,r,m,s,l,g]);const u=new N(new V({color:"black"}));u.scale.set(10,10,1),u.position.set(0,0,-1),f.addObjectToScene(u,!0),e.spawn([ve],[u]);const _=y=>{if(y.button!==2)return;M("1H_Ranged_Aiming"),setTimeout(()=>M("Idle"),2e3);const n=Y(e)(5),[{position:h}]=e.get(e.getTag(ce),[le]);Se(T,f,h,xe(),n)};Q.on("startLoop",()=>{document.addEventListener("mousedown",_)}),Q.on("stopLoop",()=>{document.removeEventListener("mousedown",_)});const b=new Audio("audio/boop.wav");b.volume=.5,e.events.on("enemyDied",async()=>{const[y]=e.get(A,[C]);y.score+=1,e.events.emit("updateScore",y),b.play()}),e.events.on("healPlayer",y=>{const[n]=e.get(A,[S]);n.hp+=y}),Ee("imgui: display player position")});function De(){const[o,t,a]=e.get(A,[C,S,U]);a.text=`${t.hp}/${t.max}HP
${o.score} points`}function M(o){ie(ue,o)}const O=de();j(O);j(O);j(O);j(O);e.addRule({types:[C,$],fn([o]){var a;(a=document.querySelector("#blocker"))==null||a.setAttribute("style","display:block");const t=document.querySelector("#load");t.setAttribute("style","display:block"),t.innerHTML=`<h1>You Have Perished. Score... ${o}</h1>`,e.deleteEntity(A)}});class je extends W{every_frame(){De(),Math.random()<.5&&me(A,E),pe(O)}}var We=Object.freeze(Object.defineProperty({__proto__:null,PLAYER_TAG:B,player:A,frustumCamera:E,animatePlayer:M,default:je},Symbol.toStringTag,{value:"Module"}));class G{}e.addRule({types:[H,G,$],fn([o],t){e.events.emit("enemyDied",{entity:t}),f.removeObjectFromScene(o),e.deleteEntity(t)}});class Oe extends W{constructor(){super(...arguments);L(this,"shootTimer")}async initialize(){setInterval(this.createGoblin,15e3)}async createGoblin(){const a={uri:"./models/villager-male/villager-male.glb"},d={mass:10,isGhost:!1,shouldRotate:!1},c={radius:.7,height:1.7},i=new S(3,3),r={},m=await F.loadModel(a);f.addObjectToScene(m);const p=T.createCapsule(d,{pos:[10,50,0],scale:[1,1,1],quat:[0,0,0,1]},c),s=e.spawn([v,q,G,S],[p,m,r,i]);m.traverse(g=>{g.userData.entityId=s});const l=new oe(e.getTag(B));e.put(s,[oe],[l])}}var $e=Object.freeze(Object.defineProperty({__proto__:null,Goblin:G,default:Oe},Symbol.toStringTag,{value:"Module"}));export{B as P,We as a,$e as g,A as p,Ne as s,Ve as t};
