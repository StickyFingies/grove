var he=Object.defineProperty;var fe=(o,t,a)=>t in o?he(o,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):o[t]=a;var j=(o,t,a)=>(fe(o,typeof t!="symbol"?t+"":t,a),a);import{w as e,P as M,e as $,p as _,a as A,I as ge,D as we,h as _e,O as be,d as H,b as Y,L as ae,V as x,i as q,j as N,T as se,k as Te,R as X,F as ne,l as re,m as Me,n as ie,o as ve,q as Q,C as ce,r as le}from"./game.d0ad9aae.js";import{G as V}from"./script.c9dee25c.js";import{Death as W,Health as v}from"./health.44648e76.js";import{KeyboardControls as Z}from"./keyboardControls.dab56049.js";import{Movement as K}from"./movement.651c1734.js";import{Score as G}from"./score.6776b201.js";import{shoot as Se}from"./shooting.2a506596.js";import{UserInterface as U}from"./userInterface.3ca2e4ed.js";import{dealDamage as F}from"./damage.system.4e7a59e5.js";import{getEquippedItem as Ae}from"./inventory.24d76a8d.js";import{d as J,s as ee,m as te,A as oe}from"./attack.1b33267a.js";const[Ie]=ae("slime");class P{constructor(){j(this,"speed",.75);j(this,"lastHop",performance.now())}}class Pe extends V{initialize(){window.webApi&&window.webApi.onmessage("slime",()=>{Ie("spawn enemy");for(let t=0;t<20;t++)this.createSlime()}),setInterval(this.createSlime,5e3)}every_frame(){const t=e.getTag(O),[a]=e.get(t,[M]);e.do_with([$,P,W],([d],i)=>{e.events.emit("enemyDied",i),e.deleteEntity(i)});const l=e.submitQuery([M,$,P]);for(const[[d,i,r],m]of l){const p=_.getBodyPosition(a),s=_.getBodyPosition(d),c=J(p,s),f=ee(p,s),{speed:y,lastHop:b}=r;let g=0,u=0;const n=new x(0,0,0);if(c<20){const h=te(f,y);n.x+=h[0]*20,n.z+=h[2]*20,g+=20}if(Math.random()<=.02)for(const[h,w]of l){if(w===m)return;const[k]=e.get(w,[M]),I=_.getBodyPosition(k),C=J(I,s),ye=ee(I,s);if(C<20){u+=1,g+=1;const z=te(ye,y);n.x+=z[0],n.y+=z[1],n.z+=z[2]}}if(u>0){const h=Math.max(Math.min(u/12,1),.02738276869058609);i.children[0].material.color.b=h,A.updateMaterial(i)}g&&performance.now()-b>1125&&(r.lastHop=performance.now(),n.x/=g,n.z/=g,_.addForceConditionalRaycast({force:{object:d,vector:[n.x,3,n.z]},raycast:{id:0,from:s,to:[s[0]+(Math.random()*3-1.5),s[1]-1.5,s[2]+(Math.random()*3-1.5)]}}))}}createInstancedSlime({geometries:t,materials:a,meshes:l}){const i=new SharedArrayBuffer(Float32Array.BYTES_PER_ELEMENT*16*400),r=new Float32Array(i),m=new ge(r,Float32Array.BYTES_PER_ELEMENT);m.setUsage(we);const p=l.map(({geometry:s,material:c,materialCount:f})=>{const y=s-1,b=c-1,g=t[y],u=a.slice(b,b+f),n=new _e(g,u[0],400);n.instanceMatrix=m;for(let h=0;h<400;h++){const w=new be;w.position.set(Math.random()*60-30,h,Math.random()*60-30),w.updateMatrix(),n.setMatrixAt(h,w.matrix)}return n.instanceMatrix.needsUpdate=!0,n});return p.forEach(s=>{s.scale.set(.7,.7,.7),A.addObjectToScene(s)}),p}async createSlime(){const t={speed:.75,lastHop:performance.now()},a=new v(5,5),l={uri:"./models/slime/slime.glb"},d={radius:1.39/2},i={mass:1,isGhost:!1,shouldRotate:!0},r=await H.loadModel(l);await H.loadModelData(l),r.children[1].material=r.children[1].material.clone(),r.scale.set(.7,.7,.7),r.name="Slime";const m=()=>Math.random()*50-25,p=_.createSphere(i,{pos:[m(),60,m()],scale:[1,1,1],quat:[0,0,0,1]},d),s=e.spawn([Y,M,P,v],[r,p,t,a]);r.traverse(c=>c.userData.entityId=s),_.registerCollisionCallback(p,F(e)(3))}}var Ne=Object.freeze(Object.defineProperty({__proto__:null,Slime:P,default:Pe},Symbol.toStringTag,{value:"Module"}));const D=Symbol("Target");function de(){const o="img/fire.png",t=new q(new N({color:16711680,transparent:!0,opacity:.3,visible:!0,map:new se().load(o),depthTest:!1}));return t.position.set(0,30,0),t.scale.set(10,10,10),A.addObjectToScene(t),{sprite:t,abilities:0}}function R(o){o.abilities+=1;const t="img/icons.jpg",a=new se().load(t);a.offset=new Te(1/10,1-1/12),a.wrapS=X,a.wrapT=X;const l=new q(new N({color:16777215,transparent:!0,visible:!0,map:a,alphaMap:a,depthTest:!1})),d=.1,i=.3,r=Math.PI/2*o.abilities,m=i*Math.sin(r),p=i*Math.cos(r);l.position.set(p,m,0),l.scale.set(d,d,d),o.sprite.add(l)}function me(o,t){const[a]=e.get(o,[M]),[l,d,i]=_.getBodyPosition(a),r=new x(l,d,i);function m(){const c=new Set;return A.scene.traverseVisible(f=>{const y=f.userData.entityId;!y||!new ne().setFromProjectionMatrix(new re().multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse)).containsPoint(f.position)||(e.has(y,P)||e.has(y,B))&&c.add(y)}),c}const p=m();let s=999999999;for(const c of p){const[f]=e.get(c,[M]),[y,b,g]=_.getBodyPosition(f),u=new x(y,b,g),n=Math.abs(u.distanceTo(r));n<s&&(s=n,e.removeTag(D),e.addTag(c,D))}}function pe({sprite:o}){if(e.hasTag(D)){const t=e.getTag(D),[a]=e.get(t,[M]),[l,d,i]=_.getBodyPosition(a),r=new x(l,d,i);o.visible=!0,o.position.copy(r),o.rotateX(.0333),o.rotateY(-.0333),o.rotateZ(.0333)}else o.visible=!1}var Ve=Object.freeze(Object.defineProperty({__proto__:null,TARGET_TAG:D,makeTargetIndicator:de,addAbilityToTargetIndicator:R,updateTargetIndicator:me,syncTargetIndicator:pe},Symbol.toStringTag,{value:"Module"}));const[Ee]=ae("engine:todo"),O=Symbol("player"),xe=()=>{const[o]=e.get(e.getTag(ce),[le]);return new x(0,0,-1).applyQuaternion(o.quaternion)},S=e.createEntity();e.addTag(S,O);const E=new Me(30,1,.1,100).rotateY(Math.PI).translateY(3).rotateX(-Math.PI/9).translateZ(1);let ue=null;A.loadModel().then(o=>{ue=o;const t=o.mesh;console.log(o.animations),ie(o,"Idle"),t.add(E);const a=800,l=10,d=new Audio("audio/squelch.mp3");let i=0;document.addEventListener("mousedown",async u=>{if(u.button!==0||performance.now()-i<a)return;i=performance.now(),T("1H_Melee_Attack_Slice_Diagonal"),setTimeout(()=>T("Idle"),340);const n=new ne().setFromProjectionMatrix(new re().multiplyMatrices(E.projectionMatrix,E.matrixWorldInverse));let h=!1;A.scene.traverseVisible(w=>{h||w.isMesh&&(n.containsPoint(w.position)||n.intersectsObject(w))&&e.has(w.userData.entityId,v)&&(h=!0,setTimeout(()=>{var I,C;const k=(C=(I=Ae())==null?void 0:I.damage)!=null?C:l;F(e)(k)(w.userData.entityId),d.currentTime=.5,d.play()},500))})});const r=new v(250,250),m={score:0},p=_.createSphere({mass:100,shouldRotate:!0,isGhost:!1},{pos:[0,20,0],scale:[1,1,1],quat:[0,0,0,1]},{radius:1}),s=new K;s.jumpVelocity=5,s.walkVelocity=14;const c=new Z({MoveForward:["w_down"],MoveBackward:["s_down"],MoveLeft:["a_down"],MoveRight:["d_down"],Idle:["w_up","a_up","s_up","d_up"]});c.addListener("Idle",()=>{T("Idle")}),c.addListener("MoveForward",()=>{T("Running_A")}),c.addListener("MoveBack",()=>{T("Running_A")}),c.addListener("MoveLeft",()=>{T("Running_A")}),c.addListener("MoveRight",()=>{T("Running_A")});const f=new U("50%","80%","52px Arial","red","[health goes here]");e.put(S,[Y,M,v,G,K,Z,U],[t,p,r,m,s,c,f]);const y=new q(new N({color:"black"}));y.scale.set(10,10,1),y.position.set(0,0,-1),e.spawn([ve],[y]);const b=u=>{if(u.button!==2)return;T("1H_Ranged_Aiming"),setTimeout(()=>T("Idle"),2e3);const n=F(e)(5),[{position:h}]=e.get(e.getTag(ce),[le]);Se(_,A,h,xe(),n)};Q.on("startLoop",()=>{document.addEventListener("mousedown",b)}),Q.on("stopLoop",()=>{document.removeEventListener("mousedown",b)});const g=new Audio("audio/boop.wav");g.volume=.5,e.events.on("enemyDied",async()=>{const[u]=e.get(S,[G]);u.score+=1,e.events.emit("updateScore",u),g.play()}),e.events.on("healPlayer",u=>{const[n]=e.get(S,[v]);n.hp+=u}),Ee("imgui: display player position")});function De(){const[o,t,a]=e.get(S,[G,v,U]);a.text=`${t.hp}/${t.max}HP
${o.score} points`}function T(o){ie(ue,o)}const L=de();R(L);R(L);R(L);R(L);e.addRule({name:"Game-over",types:[G,W],fn([o]){var a;(a=document.querySelector("#blocker"))==null||a.setAttribute("style","display:block");const t=document.querySelector("#load");t.setAttribute("style","display:block"),t.innerHTML=`<h1>You Have Perished. Score... ${o}</h1>`,e.deleteEntity(S)}});class Re extends V{every_frame(){De(),Math.random()<.5&&me(S,E),pe(L)}}var We=Object.freeze(Object.defineProperty({__proto__:null,PLAYER_TAG:O,player:S,frustumCamera:E,animatePlayer:T,default:Re},Symbol.toStringTag,{value:"Module"}));class B{}e.addRule({name:"Dead goblins disappear",types:[B,W],fn(o,t){e.events.emit("enemyDied",{entity:t}),e.deleteEntity(t)}});class Le extends V{constructor(){super(...arguments);j(this,"shootTimer")}async initialize(){setInterval(this.createGoblin,15e3)}async createGoblin(){const a={uri:"./models/villager-male/villager-male.glb"},l={mass:10,isGhost:!1,shouldRotate:!1},d={radius:.7,height:1.7},i=new v(3,3),r={},m=await H.loadModel(a),p=_.createCapsule(l,{pos:[10,50,0],scale:[1,1,1],quat:[0,0,0,1]},d),s=new oe(e.getTag(O)),c=e.spawn([M,Y,B,v,oe],[p,m,r,i,s]);m.traverse(f=>{f.userData.entityId=c})}}var $e=Object.freeze(Object.defineProperty({__proto__:null,Goblin:B,default:Le},Symbol.toStringTag,{value:"Module"}));export{O as P,We as a,$e as g,S as p,Ne as s,Ve as t};
