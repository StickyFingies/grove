var he=Object.defineProperty;var fe=(o,t,a)=>t in o?he(o,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):o[t]=a;var R=(o,t,a)=>(fe(o,typeof t!="symbol"?t+"":t,a),a);import{w as e,P as v,d as H,a as f,p as T,I as ge,D as we,h as be,O as Te,e as F,b as q,L as ae,V as x,i as N,j as V,T as se,k as _e,R as X,F as ne,l as re,m as Me,n as ie,o as ve,q as Q,C as ce,r as le}from"./game.86b6fc01.js";import{G as W}from"./script.1f479a83.js";import S,{Death as $}from"./health.92e546e3.js";import{KeyboardControls as Z}from"./keyboardControls.e4cabf82.js";import{Movement as K}from"./movement.cd205329.js";import{Score as C}from"./score.6776b201.js";import{shoot as Se}from"./shooting.80a71baf.js";import{UserInterface as U}from"./userInterface.966eab26.js";import{dealDamage as Y}from"./damage.system.b846bbb6.js";import{getEquippedItem as Ae}from"./inventory.24d76a8d.js";import{d as J,s as ee,m as te,A as oe}from"./attack.93e25690.js";const[Ie]=ae("slime");class P{constructor(){R(this,"speed",.75);R(this,"lastHop",performance.now())}}class Pe extends W{initialize(){window.webApi&&window.webApi.onmessage("slime",()=>{Ie("spawn enemy");for(let t=0;t<20;t++)this.createSlime()}),setInterval(this.createSlime,5e3)}every_frame(){const t=e.getTag(G),[a]=e.get(t,[v]);e.do_with([H,P,$],([l],c)=>{e.events.emit("enemyDied",c),f.removeObjectFromScene(l),e.deleteEntity(c)});const s=e.submitQuery([v,H,P]);for(const[[l,c,i],m]of s){const p=T.getBodyPosition(a),n=T.getBodyPosition(l),d=J(p,n),g=ee(p,n),{speed:u,lastHop:_}=i;let w=0,y=0;const r=new x(0,0,0);if(d<20){const h=te(g,u);r.x+=h[0]*20,r.z+=h[2]*20,w+=20}if(Math.random()<=.02)for(const[h,b]of s){if(b===m)return;const[k]=e.get(b,[v]),I=T.getBodyPosition(k),L=J(I,n),ye=ee(I,n);if(L<20){y+=1,w+=1;const z=te(ye,u);r.x+=z[0],r.y+=z[1],r.z+=z[2]}}if(y>0){const h=Math.max(Math.min(y/12,1),.02738276869058609);c.children[0].material.color.b=h,f.updateMaterial(c)}w&&performance.now()-_>1125&&(i.lastHop=performance.now(),r.x/=w,r.z/=w,T.addForceConditionalRaycast({force:{object:l,vector:[r.x,3,r.z]},raycast:{id:0,from:n,to:[n[0]+(Math.random()*3-1.5),n[1]-1.5,n[2]+(Math.random()*3-1.5)]}}))}}createInstancedSlime({geometries:t,materials:a,meshes:s}){const c=new SharedArrayBuffer(Float32Array.BYTES_PER_ELEMENT*16*400),i=new Float32Array(c),m=new ge(i,Float32Array.BYTES_PER_ELEMENT);m.setUsage(we);const p=s.map(({geometry:n,material:d,materialCount:g})=>{const u=n-1,_=d-1,w=t[u],y=a.slice(_,_+g),r=new be(w,y[0],400);r.instanceMatrix=m;for(let h=0;h<400;h++){const b=new Te;b.position.set(Math.random()*60-30,h,Math.random()*60-30),b.updateMatrix(),r.setMatrixAt(h,b.matrix)}return r.instanceMatrix.needsUpdate=!0,r});return p.forEach(n=>{n.scale.set(.7,.7,.7),f.addObjectToScene(n)}),p}async createSlime(){const t={speed:.75,lastHop:performance.now()},a=new S(5,5),s={uri:"./models/slime/slime.glb"},l={radius:1.39/2},c={mass:1,isGhost:!1,shouldRotate:!0},i=await F.loadModel(s);await F.loadModelData(s),i.children[1].material=i.children[1].material.clone(),i.scale.set(.7,.7,.7),i.name="Slime",f.addObjectToScene(i);const m=()=>Math.random()*50-25,p=T.createSphere(c,{pos:[m(),60,m()],scale:[1,1,1],quat:[0,0,0,1]},l),n=e.spawn([q,v,P,S],[i,p,t,a]);i.traverse(d=>d.userData.entityId=n),T.registerCollisionCallback(p,Y(e)(3))}}var Ne=Object.freeze(Object.defineProperty({__proto__:null,Slime:P,default:Pe},Symbol.toStringTag,{value:"Module"}));const D=Symbol("Target");function de(){const o="img/fire.png",t=new N(new V({color:16711680,transparent:!0,opacity:.3,visible:!0,map:new se().load(o),depthTest:!1}));return t.position.set(0,30,0),t.scale.set(10,10,10),f.addObjectToScene(t),{sprite:t,abilities:0}}function j(o){o.abilities+=1;const t="img/icons.jpg",a=new se().load(t);a.offset=new _e(1/10,1-1/12),a.wrapS=X,a.wrapT=X;const s=new N(new V({color:16777215,transparent:!0,visible:!0,map:a,alphaMap:a,depthTest:!1})),l=.1,c=.3,i=Math.PI/2*o.abilities,m=c*Math.sin(i),p=c*Math.cos(i);s.position.set(p,m,0),s.scale.set(l,l,l),o.sprite.add(s)}function me(o,t){const[a]=e.get(o,[v]),[s,l,c]=T.getBodyPosition(a),i=new x(s,l,c);function m(){const d=new Set;return f.scene.traverseVisible(g=>{const u=g.userData.entityId;!u||!new ne().setFromProjectionMatrix(new re().multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse)).containsPoint(g.position)||(e.has(u,P)||e.has(u,B))&&d.add(u)}),d}const p=m();let n=999999999;for(const d of p){const[g]=e.get(d,[v]),[u,_,w]=T.getBodyPosition(g),y=new x(u,_,w),r=Math.abs(y.distanceTo(i));r<n&&(n=r,e.removeTag(D),e.addTag(d,D))}}function pe({sprite:o}){if(e.hasTag(D)){const t=e.getTag(D),[a]=e.get(t,[v]),[s,l,c]=T.getBodyPosition(a),i=new x(s,l,c);o.visible=!0,o.position.copy(i),o.rotateX(.0333),o.rotateY(-.0333),o.rotateZ(.0333)}else o.visible=!1}var Ve=Object.freeze(Object.defineProperty({__proto__:null,TARGET_TAG:D,makeTargetIndicator:de,addAbilityToTargetIndicator:j,updateTargetIndicator:me,syncTargetIndicator:pe},Symbol.toStringTag,{value:"Module"}));const[Ee]=ae("engine:todo"),G=Symbol("player"),xe=()=>{const[o]=e.get(e.getTag(ce),[le]);return new x(0,0,-1).applyQuaternion(o.quaternion)},A=e.createEntity();e.addTag(A,G);const E=new Me(30,1,.1,100).rotateY(Math.PI).translateY(3).rotateX(-Math.PI/9).translateZ(1);let ue=null;f.loadModel().then(o=>{ue=o;const t=o.mesh;console.log(o.animations),ie(o,"Idle"),t.add(E),f.addObjectToScene(t);const a=800,s=10,l=new Audio("audio/squelch.mp3");let c=0;document.addEventListener("mousedown",async y=>{if(y.button!==0||performance.now()-c<a)return;c=performance.now(),M("1H_Melee_Attack_Slice_Diagonal"),setTimeout(()=>M("Idle"),340);const r=new ne().setFromProjectionMatrix(new re().multiplyMatrices(E.projectionMatrix,E.matrixWorldInverse));let h=!1;f.scene.traverseVisible(b=>{h||b.isMesh&&(r.containsPoint(b.position)||r.intersectsObject(b))&&e.has(b.userData.entityId,S)&&(h=!0,setTimeout(()=>{var I,L;const k=(L=(I=Ae())==null?void 0:I.damage)!=null?L:s;Y(e)(k)(b.userData.entityId),l.currentTime=.5,l.play()},500))})});const i=new S(250,250),m={score:0},p=T.createSphere({mass:100,shouldRotate:!0,isGhost:!1},{pos:[0,20,0],scale:[1,1,1],quat:[0,0,0,1]},{radius:1}),n=new K;n.jumpVelocity=5,n.walkVelocity=14;const d=new Z({MoveForward:["w_down"],MoveBackward:["s_down"],MoveLeft:["a_down"],MoveRight:["d_down"],Idle:["w_up","a_up","s_up","d_up"]});d.addListener("Idle",()=>{M("Idle")}),d.addListener("MoveForward",()=>{M("Running_A")}),d.addListener("MoveBack",()=>{M("Running_A")}),d.addListener("MoveLeft",()=>{M("Running_A")}),d.addListener("MoveRight",()=>{M("Running_A")});const g=new U("50%","80%","52px Arial","red","[health goes here]");e.put(A,[q,v,S,C,K,Z,U],[t,p,i,m,n,d,g]);const u=new N(new V({color:"black"}));u.scale.set(10,10,1),u.position.set(0,0,-1),f.addObjectToScene(u,!0),e.spawn([ve],[u]);const _=y=>{if(y.button!==2)return;M("1H_Ranged_Aiming"),setTimeout(()=>M("Idle"),2e3);const r=Y(e)(5),[{position:h}]=e.get(e.getTag(ce),[le]);Se(T,f,h,xe(),r)};Q.on("startLoop",()=>{document.addEventListener("mousedown",_)}),Q.on("stopLoop",()=>{document.removeEventListener("mousedown",_)});const w=new Audio("audio/boop.wav");w.volume=.5,e.events.on("enemyDied",async()=>{const[y]=e.get(A,[C]);y.score+=1,e.events.emit("updateScore",y),w.play()}),e.events.on("healPlayer",y=>{const[r]=e.get(A,[S]);r.hp+=y}),Ee("imgui: display player position")});function De(){const[o,t,a]=e.get(A,[C,S,U]);a.text=`${t.hp}/${t.max}HP
${o.score} points`}function M(o){ie(ue,o)}const O=de();j(O);j(O);j(O);j(O);class je extends W{every_frame(){De(),e.do_with([C,$],([{score:t}])=>{var s;(s=document.querySelector("#blocker"))==null||s.setAttribute("style","display:block");const a=document.querySelector("#load");a.setAttribute("style","display:block"),a.innerHTML=`<h1>You Have Perished. Score... ${t}</h1>`,e.deleteEntity(A)}),Math.random()<.5&&me(A,E),pe(O)}}var We=Object.freeze(Object.defineProperty({__proto__:null,PLAYER_TAG:G,player:A,frustumCamera:E,animatePlayer:M,default:je},Symbol.toStringTag,{value:"Module"}));class B{}class Oe extends W{constructor(){super(...arguments);R(this,"shootTimer")}async initialize(){setInterval(this.createGoblin,15e3)}every_frame(){e.do_with([H,B,$],([a],s)=>{e.events.emit("enemyDied",{entity_id:s}),f.removeObjectFromScene(a),e.deleteEntity(s)})}async createGoblin(){const a={uri:"./models/villager-male/villager-male.glb"},s={mass:10,isGhost:!1,shouldRotate:!1},l={radius:.7,height:1.7},c=new S(3,3),i={},m=await F.loadModel(a);f.addObjectToScene(m);const p=T.createCapsule(s,{pos:[10,50,0],scale:[1,1,1],quat:[0,0,0,1]},l),n=e.spawn([v,q,B,S],[p,m,i,c]);m.traverse(g=>{g.userData.entityId=n});const d=new oe(e.getTag(G));e.put(n,[oe],[d])}}var $e=Object.freeze(Object.defineProperty({__proto__:null,Goblin:B,default:Oe},Symbol.toStringTag,{value:"Module"}));export{G as P,We as a,$e as g,A as p,Ne as s,Ve as t};
